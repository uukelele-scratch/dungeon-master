name: Build and Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  # Windows
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Portable EXE
        run: pyinstaller --noconfirm --onefile --windowed --name "DungeonMaster" --icon "assets/icon.ico" --add-data "assets;assets" src/main.py

      - name: Build Folder for Installer
        run: pyinstaller --noconfirm --onedir --windowed --name "DungeonMaster" --icon "assets/icon.ico" --add-data "assets;assets" src/main.py

      - name: Set Installer Version
        shell: bash # with git bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Injecting version: $VERSION"
          sed -i -E "s/#define AppVersion[[:space:]]+\".*\"/#define AppVersion \"$VERSION\"/" installer_script.iss
          grep "AppVersion" installer_script.iss

      - name: Compiling Installer via Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
        with:
          path: installer_script.iss

      - name: Prepare Artifacts
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME}"
          mkdir release_upload
          
          mv dist/DungeonMaster.exe release_upload/DungeonMaster-${VERSION}-windows-x64.exe
          
          mv Output/DungeonMaster_Installer_*.exe release_upload/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: release_upload/*

  # Linux (AppImage + Flatpak)
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install System Deps
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder fuse3 libfuse2

      - name: Install Python Deps
        run: pip install -r requirements.txt pyinstaller

      - name: Build PyInstaller Binary
        run: pyinstaller --noconfirm --onefile --windowed --name "DungeonMaster" --add-data "assets:assets" src/main.py

      - name: Build AppImage Folder
        run: pyinstaller --noconfirm --onedir --windowed --name "DungeonMaster_Dir" --add-data "assets:assets" src/main.py

      - name: Package as AppImage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps/
          
          cp dist/DungeonMaster_Dir/* AppDir/usr/bin/
          
          cp assets/icon.png AppDir/dungeonmaster.png
          cp assets/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/dungeonmaster.png
          
          cat > AppDir/dungeonmaster.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Dungeon Master
          Exec=DungeonMaster_Dir
          Icon=dungeonmaster
          Categories=Game;
          EOF
          
          ln -s usr/bin/DungeonMaster_Dir AppDir/AppRun
          
          wget -O appimagetool "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool
          ./appimagetool AppDir DungeonMaster.AppImage

      - name: Build Flatpak
        run: |
          flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y flathub org.kde.Sdk//5.15-24.08 org.kde.Platform//5.15-24.08
          
          flatpak-builder --user --force-clean --disable-cache --repo=repo build-dir dev.uukelele.dungeonmaster.json

          flatpak build-bundle repo DungeonMaster.flatpak dev.uukelele.dungeonmaster

      - name: Prepare Artifacts
        run: |
          VERSION="${GITHUB_REF_NAME}"
          mkdir release_upload
          
          mv dist/DungeonMaster release_upload/DungeonMaster-${VERSION}-linux-x86_64
          
          mv DungeonMaster.AppImage release_upload/DungeonMaster-${VERSION}-linux-x86_64.AppImage
          
          mv DungeonMaster.flatpak release_upload/dev.uukelele.dungeonmaster-${VERSION}.flatpak


      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: release_upload/*

  # macOS
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install Deps
        run: |
          pip install -r requirements.txt pyinstaller
          brew install create-dmg

      - name: Build .app
        run: pyinstaller --noconfirm --windowed --name "DungeonMaster" --icon "assets/icon.png" --add-data "assets:assets" src/main.py

      - name: Create DMG
        run: |
          mkdir -p dist_dmg
          create-dmg \
            --volname "Dungeon Master" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "DungeonMaster.app" 200 190 \
            --hide-extension "DungeonMaster.app" \
            --app-drop-link 600 185 \
            "dist_dmg/DungeonMaster.dmg" \
            "dist/DungeonMaster.app"

      - name: Prepare Artifacts
        run: |
          VERSION="${GITHUB_REF_NAME}"
          mkdir release_upload
          
          mv dist_dmg/DungeonMaster.dmg release_upload/DungeonMaster-${VERSION}-macos-universal.dmg

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: release_upload/*

  publish:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        
      - name: Publish to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows-builds/*
            linux-builds/*
            macos-builds/*